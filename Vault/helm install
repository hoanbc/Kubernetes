[root@srv-master1 consul]# vim consul-values.yaml
[root@srv-master1 consul]# helm update consul hashicorp/consul --namespace hbc-vault -f consul-values.yaml
Error: unknown command "update" for "helm"
Run 'helm --help' for usage.
[root@srv-master1 consul]# helm upgrade consul hashicorp/consul --namespace hbc-vault -f consul-values.yaml
Release "consul" has been upgraded. Happy Helming!
NAME: consul
LAST DEPLOYED: Sun Jul 17 14:14:22 2022
NAMESPACE: hbc-vault
STATUS: deployed
REVISION: 2
NOTES:
Thank you for installing HashiCorp Consul!

Your release is named consul.

To learn more about the release, run:

  $ helm status consul --namespace hbc-vault
  $ helm get all consul --namespace hbc-vault


[root@srv-master1 consul]# helm install vault hashicorp/vault --namespace hbc-vault -f vault-values.yaml
NAME: vault
LAST DEPLOYED: Sun Jul 17 14:21:36 2022
NAMESPACE: hbc-vault
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://www.vaultproject.io/docs/


Your release is named vault. To learn more about the release, try:

 
[root@srv-master1 consul]# kubectl exec pod/vault-0 -n hbc-vault -- vault status
Key                Value
---                -----
Seal Type          shamir
Initialized        false
Sealed             true
Total Shares       0
Threshold          0
Unseal Progress    0/0
Unseal Nonce       n/a
Version            1.10.3
Storage Type       consul
HA Enabled         true

[root@srv-master1 consul]# kubectl -n hbc-vault exec vault-0 -- vault operator init -key-shares=1 -key-threshold=1 -format=json > cluster-keys.json
[root@srv-master1 consul]# cat cluster-keys.json
{
  "unseal_keys_b64": [
    "WOZTrIWDdM2e931xWgoZx0Ks9a4bTTnQdIhR8pSE4LI="
  ],
  "unseal_keys_hex": [
    "58e653ac858374cd9ef77d715a0a19c742acf5ae1b4d39d0748851f29484e0b2"
  ],
  "unseal_shares": 1,
  "unseal_threshold": 1,
  "recovery_keys_b64": [],
  "recovery_keys_hex": [],
  "recovery_keys_shares": 5,
  "recovery_keys_threshold": 3,
  "root_token": "hvs.rIgcO7xAcGGL59q5iYtDk8sY"
}
[root@srv-master1 consul]#
[root@srv-master1 consul]# VAULT_UNSEAL_KEY=WOZTrIWDdM2e931xWgoZx0Ks9a4bTTnQdIhR8pSE4LI=
[root@srv-master1 consul]# kubectl -n hbc-vault exec vault-0 -- vault operator unseal $VAULT_UNSEAL_KEY
Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.10.3
Storage Type    consul
Cluster Name    vault-cluster-00c6f128
Cluster ID      1e41ec77-fbbd-8c2d-8e8f-4ffc0a3c4e8c
HA Enabled      true
HA Cluster      https://vault-0.vault-internal:8201
HA Mode         active
Active Since    2022-07-17T07:24:50.608652241Z
[root@srv-master1 consul]# kubectl -n hbc-vault exec vault-1 -- vault operator unseal $VAULT_UNSEAL_KEY
Key                    Value
---                    -----
Seal Type              shamir
Initialized            true
Sealed                 false
Total Shares           1
Threshold              1
Version                1.10.3
Storage Type           consul
Cluster Name           vault-cluster-00c6f128
Cluster ID             1e41ec77-fbbd-8c2d-8e8f-4ffc0a3c4e8c
HA Enabled             true
HA Cluster             https://vault-0.vault-internal:8201
HA Mode                standby
Active Node Address    http://10.2.201.150:8200



vault write auth/kubernetes/config \
token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
kubernetes_host=https://kubernetes.default.svc:443 \
kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
issuer="https://kubernetes.default.svc.cluster.local"

vault auth enable kubernetes


  hvs.rIgcO7xAcGGL59q5iYtDk8sY

  "unseal_keys_b64": [

  ],
  "unseal_keys_hex": [
    "58e653ac858374cd9ef77d715a0a19c742acf5ae1b4d39d0748851f29484e0b2"
  ],
  "unseal_shares": 1,
  "unseal_threshold": 1,
  "recovery_keys_b64": [],
  "recovery_keys_hex": [],
  "recovery_keys_shares": 5,
  "recovery_keys_threshold": 3,
  "root_token": ""

WOZTrIWDdM2e931xWgoZx0Ks9a4bTTnQdIhR8pSE4LI=
hvs.rIgcO7xAcGGL59q5iYtDk8sY

policy-project1
secret-project1/databases

secret-project1/databases

secret-project1/databases/mysql
secret-project1/databases

secret-project1/data/databases/mysql
{
  "password": "sUp3rS3cUr3P@ssw0rd",
  "username": "dbuser"
}{
  "password": "sUp3rS3cUr3P@ssw0rd",
  "username": "dbuser"
}

vault auth enable --path hbc-k8s kubernetes
vault write auth/hbc-k8s/config \
token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
kubernetes_host=https://kube-apiserver.systemtest.local \
kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
issuer="https://kubernetes.default.svc.cluster.local"
exit